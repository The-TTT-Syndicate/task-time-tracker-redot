name: Build and Release Redot Project
on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build-windows:
    name: Build for Windows
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Build for Windows
        id: build-windows
        uses: felix-schindler/build-godot-action@v2.0.0
        with:
          name: task_time_tracker
          preset: "Windows Desktop"
          debugMode: "false"
          package: "false"
          projectDir: "."
  
      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: win-artifact
          path: output/win-x64/task-time-tracker.exe

  build-macos:
    name: Build for macOS
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Build for macOS
        id: build-macos
        uses: felix-schindler/build-godot-action@v2.0.0
        with:
          name: task_time_tracker
          preset: "macOS"
          debugMode: "false"
          package: "false"
          projectDir: "."

      - name: Upload macOS Artifact
        uses: actions/upload-artifact@v4
        with:
          name: mac-artifact
          path: ${{ steps.build-macos.outputs.build }}

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-windows, build-macos]
    if: github.event_name == 'push'
    steps:
      - name: Download Windows Artifact
        uses: actions/download-artifact@v4
        with:
          name: win-artifact
          path: output/win/

      - name: Download macOS Artifact
        uses: actions/download-artifact@v4
        with:
          name: mac-artifact
          path: output/mac/

      - name: Create GitHub Release and Upload Artifacts
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: "Release ${{ github.ref_name }}"
          files: |
            output/win/*
            output/mac/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
